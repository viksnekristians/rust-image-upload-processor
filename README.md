# Rust Image Upload Processor

A Rust project for uploading images, saving them to disk, storing metadata in a MySQL database, and generating thumbnails via a worker queue.

---

## Local Setup

1. **Clone the repository**

    ```bash
    git clone https://github.com/viksnekristians/rust-image-upload-processor.git
    cd rust-image-upload-processor
    ```

2. **Set up your MySQL database**

    - Start MySQL locally or in Docker.
    - Create the database and user:

        ```sql
        CREATE DATABASE image_processor;
        CREATE USER 'rustuser'@'localhost' IDENTIFIED BY 'rustpass';
        GRANT ALL PRIVILEGES ON image_processor.* TO 'rustuser'@'localhost';
        FLUSH PRIVILEGES;
        ```

3. **Create a `.env` file in the project root**

    ```env
    DATABASE_URL=mysql://rustuser:rustpass@localhost/image_processor
    ```

4. **Install cargo-dotenv and sqlx-cli**

    ```bash
    cargo install cargo-dotenv
    cargo install sqlx-cli --no-default-features --features mysql
    ```

5. **Prepare the database schema**

    - Create the `files` table:

        ```sql
        CREATE TABLE files (
            id SERIAL PRIMARY KEY,
            file_name VARCHAR(255) NOT NULL,
            directory VARCHAR(255),
            type VARCHAR(100),
            original_name VARCHAR(255),
            origin VARCHAR(100)
        );
        ```

6. **Prepare SQLx query cache using dotenv**

    ```bash
    cargo dotenv sqlx prepare
    ```

7. **Prepare SQLx query cache using dotenv**

    ```bash
    docker exec -it redis-server redis-cli
    ```

8. **Build and run the project**

    ```bash
    cargo run
    ```

---

## Usage

- **Upload an image:**

    ```bash
    curl -X POST -F "image=@imagename;type=image/jpeg" http://localhost:3000/upload
    ```

- Uploaded files are saved in the `uploads/` directory at the project root.
- Thumbnails are generated by worker jobs and saved as `<randomfilename>_thumb.<ext>` in the `uploads/thumbnails`.
- File metadata is stored in the `files` table in your MySQL database.
- Multiple requests can be processed in parallel and thumbnails generated by separate workers

---


## Notes

- The project uses Axum for HTTP, SQLx for MySQL, and the `image` crate for image processing.
- The worker system processes jobs for thumbnail generation after upload.
- The database pool and job queue are managed as shared state in the application.
- `.env` is used for configuration, and `cargo-dotenv` ensures environment variables are loaded for both running and preparing SQLx queries.
